---
apiVersion: v1
kind: Secret
metadata:
  name: selfsigned-tls
type: kubernetes.io/tls
data:
  # cat selfsigned.crt | base64
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURMVENDQWhXZ0F3SUJBZ0lVTTFmbUttM1gxSm1Td2dpTDYvTzZseDh0U2V3d0RRWUpLb1pJaHZjTkFRRUwKQlFBd0pqRWtNQ0lHQTFVRUF3d2JjMlZzWm5OcFoyNWxaQzEzWVd4cGJtVXVZblZ5YTJ3dVkyOXRNQjRYRFRJegpNRE15T0RFeE16RXlPVm9YRFRJek1EUXdOekV4TXpFeU9Wb3dKakVrTUNJR0ExVUVBd3diYzJWc1puTnBaMjVsClpDMTNZV3hwYm1VdVluVnlhMnd1WTI5dE1JSUJJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBUThBTUlJQkNnS0MKQVFFQXNZZmdqU1c1WHlPS1U3ZGpGNnA4aGFuc2xtdVkwUmZEUTg1NU14Zm9mNlNUbFdjY3pzVnVjUzNQKzcrVQpmSW13RmJzUE1yNVdUekhONG5NZWVMenVXbFhkaTIrN0RzajJ2R0M0OEFyTzVPL1d3V0JlWlI0RG5ETHY0Kzc4Ck5rK0FPSVVsOHNQclZiZXhBL2kwbUtROVluWVNrM0U3L1hveDh6bzBsSUpNRFh0K0xJbkNQLzk0UW9lU29za2MKcXpwWkV4c3A0ekVydEFsb1FMc2pZVGQzMGFGdDQzV29QaDRiTkRqUzRodGxQbGkzTUIyQlRreE91K1FxVThPbAp0eUs3UmVTUW52M0dreFNnU2NKbi84dFpMTUtFVzFYaFFGUEMwb0dheENqMk9IOWZuT3p3SU1KUEVhV1h0bVRoCmwwMnp6S3RWbk92VnlkTE1seis1bEFUYnVRSURBUUFCbzFNd1VUQWRCZ05WSFE0RUZnUVVkaUIwM3NjQ3JoYS8KcWN0SDZldFJFQzhOMkxrd0h3WURWUjBqQkJnd0ZvQVVkaUIwM3NjQ3JoYS9xY3RINmV0UkVDOE4yTGt3RHdZRApWUjBUQVFIL0JBVXdBd0VCL3pBTkJna3Foa2lHOXcwQkFRc0ZBQU9DQVFFQUs1bGRXaDdaU0diUjJiRGdacXRSCjA1elpyVXFWTVp5WGp1dlZwVzM3bjRxdzNZMzExZFF5UEJmYUZzVjJ4VXNaSXFWMStGajlGOVUrbEVQaDBEdGoKbWJxa1cxL1NRbVhsUHNBSUl6dUpFR3N3TnpRM2llOE9mNHRJMHFHV1pXRDg0dnlZeTcvQndOdEZCeE9XbzA4WQo2cEJNcVNOL2lla3JHaS9HZXI4ellLL2RQNHZuUTlRRTJZaDdqbGZlYy9mY3dkTGdPNENoOXkrZkJoZVBiNUdFClBpNkZMZU05cUJoUitjbGFYK2phaGlGRmR3U1JoMkY0a1FqeHJGRURWb3VuZHl2WnZKZWFJaFVpZGFibWlZUkUKVlBLQlBVUjNZTm9PTTlHS3lFS0hiSTA0TGMwQm80V295RnJRV1VEYXJTaTZEdEp1a3F6YlVCb2xaZjBMNE8reQpDUT09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
  # cat selfsigned.key | base64
  tls.key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBc1lmZ2pTVzVYeU9LVTdkakY2cDhoYW5zbG11WTBSZkRRODU1TXhmb2Y2U1RsV2NjCnpzVnVjUzNQKzcrVWZJbXdGYnNQTXI1V1R6SE40bk1lZUx6dVdsWGRpMis3RHNqMnZHQzQ4QXJPNU8vV3dXQmUKWlI0RG5ETHY0Kzc4TmsrQU9JVWw4c1ByVmJleEEvaTBtS1E5WW5ZU2szRTcvWG94OHpvMGxJSk1EWHQrTEluQwpQLzk0UW9lU29za2NxenBaRXhzcDR6RXJ0QWxvUUxzallUZDMwYUZ0NDNXb1BoNGJORGpTNGh0bFBsaTNNQjJCClRreE91K1FxVThPbHR5SzdSZVNRbnYzR2t4U2dTY0puLzh0WkxNS0VXMVhoUUZQQzBvR2F4Q2oyT0g5Zm5PencKSU1KUEVhV1h0bVRobDAyenpLdFZuT3ZWeWRMTWx6KzVsQVRidVFJREFRQUJBb0lCQUViTHorR1oxS1c3RDVPNQpBenhSMFp5Z0dlZ1dlbmVQeVYvRi9CRkRESVd5aE9SRW5YbGJ4R0pBQ2J2ME4ydStvTWpac3dMaVlwcnNXcFZlCm9SMDNBcnBsbVpiY2RMVTlzUitJVnRmckIzekdwRmF6YnBGV2Vjd1ZpQkxXb0Irc2JvNmJrbm1RWmMzbUZpSm0KVU9hNlFIeCtaNFFDMlJDSlpWZ0FzeTB5Rk5BZTcrNFR6TWZHN1F0dUZ5L0lzMnVHREhCbHRmNjVUUnAwOUJpQQpobFF1T251bG5aMWhjcE5NcUpxWWY1NDJqbWFEeXY4c21LSkZsWFNpNk8xOXh0V3lTazdqZVZwNTRuN29xSzRSClJjbTFEUEJ0TFphdzVraGM1UTZtLzV1NVBoQy9Wd3VIbDNZc1NHamdFZEQrUGpxdyttdS81TUM3MXQzNUlUWXcKYUE4TmVtMENnWUVBNGVVVFA3WXA2TFpXUnUxUklhS2hLSFhpY2ptMHA0eGdZWXFhRnNReXEzeDBSNkJXSWVlRQpvTVVYSTRTTmhMVWhxUUpUOHNxRGVsVTZ0WWlYcmpxbXBZVHpkbURhLzVSZDJSWXArenZHNyt0a2c5UEpLcWdRCjZoU3ZTdS9qM0tlWkdOTmlvYmI4UG9Rd3VTTmE5amFObmFQRWxTU1J6dUV2cEVoZENpQlNjMThDZ1lFQXlUREEKRXU5YkEzaXdWYXdCN1B3azNJSGtKcHZ0UXdKQVlLL0JqbjMyVXZOZWtHeHk2WnMwRm84TnJsSDI5SHFBS1pZZQorVG5iZG9mVFFjdWdEcS9LamhaTTFVUEdqZzZVc2Mwdm91QUdCK1V1dXRaV2xiQ1hSS2FnTDgralliTGJGNkpOCnlvTVdWTldCaWFzTDR0ak1weDk4S2hFcGlNNVR3OGtrOERSQjMrY0NnWUVBa0xIR0thcEtuL2lqdlJ6b09nNU4KQW5pNFN3aHhrbDBWbzRVL2ZGUENUUndUODRsZGdxd2t4VUpadHZPQ0hyNVRTRW5vY2YyTVNFRHRzVGhFU0dMagpPZVMyZWw1Q0NUSUZCemZ1UGpJbEZLc0lJSFQ1UjJ5T0lSS00wZ2hsUVlMTlN4eWo4Z2dlL1FCNW9TMW5aNHk4CkczeTZQL3BEdDJ1QXM4OXlZVGtnOXlzQ2dZRUFtSEFQbUVrek5KWWxSVVJtMFNEYTdSaWR2WU0zYWlZeWtRK2EKSUZUZ1prbHZ4UTNtbzRtdEZjcWVHdzZQaHYycVRkZ283NzBldzloMkFNeEFJZUNnSUxoVXp1SGpkNDhrcXZORQp2S3Z3NWRxSVpaZ3hVb25TazNtTXRhMGxwY2pXcURtWnAyOWJaRHZCUW9ZUEkzb1ExaS9NN0RMRXZadFhiR2pqClMvek1UTkVDZ1lCdUNjTEpvMEVENlNiRU5ieDhJTDlENWxtWjljT2UrMmFsT1VBYWE3NEpHd2N3bWlUcCtaVSsKalhDVGltbDdHby9yaE43NzlEWVB5N0drU2d1Z1NUMHMyczRVYzNSMVlPSCttOTV5dzYreTQvc2svRUczWXZJSworZmVEOUFLZ0ZJT3lORGVRRkpLZjJJUVFpb0U3TGdFdThzRzBkM0ZsRkczTWVqSnBWTnNsa3c9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: confnginx
data:
  nginx.conf: |
    user  www-data;
    worker_processes  1;
    error_log  /var/log/nginx/error.log warn;
    pid        /var/run/nginx.pid;
    events {
        worker_connections  1024;
    }
    http {
      include       /etc/nginx/mime.types;
      default_type  application/octet-stream;
      log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                          '$status $body_bytes_sent "$http_referer" '
                          '"$http_user_agent" "$http_x_forwarded_for"';
      access_log  /var/log/nginx/access.log  main;
      sendfile        on;
      keepalive_timeout  65;
      server {
        listen 80;

        resolver kube-dns.kube-system.svc.cluster.local valid=5s;

        location /healthz {
          return 200;
        }

        location / {
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection "Upgrade";
          proxy_pass http://messageboard-frontend-web;
          proxy_set_header Host $host;
          proxy_http_version 1.1;
        }

        location /waline/ {
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection "Upgrade";
          proxy_pass http://waline:8360/;
          proxy_set_header Host $host;
          proxy_http_version 1.1;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
          proxy_set_header REMOTE-HOST $remote_addr;
          add_header X-Cache $upstream_cache_status;
          # cache
          add_header Cache-Control no-cache;
          expires 12h;
        }
      }
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  labels:
    app: nginx
spec:
  selector:
    matchLabels:
      app: nginx
  replicas: 1
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
        - name: nginx
          image: quay.io/jitesoft/nginx:stable
          ports:
          - containerPort: 80
          volumeMounts:
            - name: nginx-config
              mountPath: /etc/nginx/nginx.conf
              subPath: nginx.conf
      volumes:
        - name: nginx-config
          configMap:
            name: confnginx
---
kind: Service
apiVersion: v1
metadata:
  name: message-board
spec:
  type: ClusterIP
  selector:
    app: nginx
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
    name: nginx
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: selfsigned
  #annotations:
    # ADDED
  #  nginx.ingress.kubernetes.io/whitelist-source-range: 173.245.48.0/20, 103.21.244.0/22, 103.22.200.0/22, 103.31.4.0/22, 141.101.64.0/18, 108.162.192.0/18, 190.93.240.0/20, 188.114.96.0/20, 197.234.240.0/22, 198.41.128.0/17, 162.158.0.0/15, 104.16.0.0/13, 104.24.0.0/14, 172.64.0.0/13, 131.0.72.0/22, 2400:cb00::/32, 2606:4700::/32, 2803:f800::/32, 2405:b500::/32, 2405:8100::/32, 2a06:98c0::/29, 2c0f:f248::/32

spec:
  # ADDED
  tls:
    - hosts:
        - selfsigned-waline.burkl.com
      secretName: selfsigned-tls

  rules:
    - host: selfsigned-waline.burkl.com
      http:
        paths:
          - path: /*
            pathType: ImplementationSpecific
            backend:
              service:
                name: message-board
                port:
                  number: 80